<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiz Host</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: wss:; connect-src https: wss:;
                 img-src https: data:; style-src 'self' 'unsafe-inline' https:;
                 script-src 'self' https: 'unsafe-inline'; frame-ancestors 'self' https://*.office.com https://*.officeapps.live.com https://*.sharepoint.com;">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {margin:0;padding:12px;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    button {padding:8px 12px;margin:6px 6px 0 0;border:1px solid #ccc;border-radius:4px;background:#fff;cursor:pointer}
    button:hover {background:#f5f5f5}
    button:disabled {opacity:0.6;cursor:not-allowed}
    button.activate {background:#dc3545;color:white;border-color:#dc3545}
    button.activate:hover {background:#c82333}
    button.deactivate {background:#28a745;color:white;border-color:#28a745}
    button.deactivate:hover {background:#218838}
    .row {margin:8px 0}
    .status {margin:8px 0;padding:4px 8px;border-radius:4px}
    .status.connected {background:#d4edda;color:#155724}
    .status.disconnected {background:#f8d7da;color:#721c24}
    .status.connecting {background:#fff3cd;color:#856404}
    input {padding:4px 8px;border:1px solid #ccc;border-radius:4px;margin:0 4px}
    .phase-info {margin:8px 0;padding:8px;background:#f8f9fa;border-radius:4px;border-left:4px solid #007bff}
    .players-list {margin:8px 0;max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:4px}
    .player-item {padding:4px 8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
    .player-item:last-child {border-bottom:none}
    .quiz-controls {margin:12px 0;padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6}
    .quiz-controls h3 {margin:0 0 8px 0;font-size:16px;color:#495057}
    .timer-input {width:60px}
    .note {font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="row">
    –ö–æ–º–Ω–∞—Ç–∞: <input id="room" value="R1" size="8">
    <button id="connect">Connect</button>
    <div id="status" class="status disconnected">‚Äî</div>
  </div>

  <div class="quiz-controls">
    <h3>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏–∑–æ–º (—á–µ—Ä–µ–∑ WebSocket)</h3>
    <div class="row">
      <label>–¢–∞–π–º–µ—Ä (—Å–µ–∫):</label>
      <input id="timer" type="number" value="30" min="0" max="300" class="timer-input">
      <span class="note">0 = –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏</span>
    </div>
    <div class="row">
      <button id="activate-question" class="activate">üî¥ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
      <button id="activate-players" class="activate">üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
      <button id="deactivate-question" class="deactivate">‚èπÔ∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É</button>
    </div>
  </div>

  <div class="row">
    <button data-act="ready" data-delay="3000">Ready 3s</button>
    <button data-act="start">Start now</button>
    <button data-act="active">Activate players</button>
    <button data-act="finish">Finish</button>
    <button data-act="reset">Reset</button>
  </div>

  <div id="phase-info" class="phase-info" style="display:none">
    <strong>–§–∞–∑–∞:</strong> <span id="current-phase">‚Äî</span><br>
    <strong>–í–∫–ª—é—á–µ–Ω–∏–µ:</strong> <span id="enable-time">‚Äî</span>
  </div>

  <div id="players-list" class="players-list" style="display:none">
    <div style="padding:4px 8px;background:#f5f5f5;font-weight:bold;border-bottom:1px solid #ddd">–ò–≥—Ä–æ–∫–∏:</div>
    <div id="players-content"></div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
  <div id="answer-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;min-width:300px">
      <h3 style="margin:0 0 15px 0">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</h3>
      <p><strong>–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç:</strong> <span id="first-answerer">‚Äî</span></p>
      <p><strong>–û—Ç–≤–µ—Ç:</strong> <span id="player-answer">‚Äî</span></p>
      <div style="margin:15px 0">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤:</label>
        <input id="points-input" type="number" value="10" min="0" max="100" style="width:80px;margin-left:10px">
      </div>
      <div style="text-align:right;margin-top:20px">
        <button id="answer-correct" style="background:#28a745;color:white;border:none;padding:8px 16px;margin-right:10px;border-radius:4px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</button>
        <button id="answer-wrong" style="background:#dc3545;color:white;border:none;padding:8px 16px;margin-right:10px;border-radius:4px">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</button>
        <button id="answer-cancel" style="background:#6c757d;color:white;border:none;padding:8px 16px;border-radius:4px">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<script>
(() => {
  let ws;
  const $room = document.getElementById('room');
  const $status = document.getElementById('status');
  const $phaseInfo = document.getElementById('phase-info');
  const $currentPhase = document.getElementById('current-phase');
  const $enableTime = document.getElementById('enable-time');
  const $playersList = document.getElementById('players-list');
  const $playersContent = document.getElementById('players-content');
  const $timer = document.getElementById('timer');
  const $activateBtn = document.getElementById('activate-question');
  const $activatePlayersBtn = document.getElementById('activate-players');
  const $deactivateBtn = document.getElementById('deactivate-question');
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏
  const $answerModal = document.getElementById('answer-modal');
  const $firstAnswerer = document.getElementById('first-answerer');
  const $playerAnswer = document.getElementById('player-answer');
  const $pointsInput = document.getElementById('points-input');
  const $answerCorrect = document.getElementById('answer-correct');
  const $answerWrong = document.getElementById('answer-wrong');
  const $answerCancel = document.getElementById('answer-cancel');

  function updateStatus(text, className) {
    $status.textContent = text;
    $status.className = `status ${className}`;
  }

  function openWs() {
    if (ws) try { ws.close(); } catch {}
    const url = `wss://wise-dream.ru/quiz/ws?room=${encodeURIComponent($room.value)}&role=host`;
    ws = new WebSocket(url);
    ws.onopen = () => updateStatus('Connected', 'connected');
    ws.onclose = () => updateStatus('Closed', 'disconnected');
    ws.onerror = () => updateStatus('Error', 'disconnected');
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'state') {
        updatePhaseInfo(msg.data);
        updatePlayersList(msg.data);
      } else if (msg.type === 'answer_received') {
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É —Å –æ—Ç–≤–µ—Ç–æ–º –∏–≥—Ä–æ–∫–∞
        showAnswerModal(msg.data);
      }
    };
  }

  function sendHostSetState(phase, delayMs) {
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify({
      type: 'host_set_state',
      quizId: $room.value.trim(),
      phase,
      ...(typeof delayMs === 'number' ? { delayMs } : {})
    }));
  }

  function updatePhaseInfo(state) {
    $currentPhase.textContent = state.phase || 'lobby';
    if (state.enableAt) {
      const enableDate = new Date(state.enableAt);
      $enableTime.textContent = enableDate.toLocaleTimeString();
      $phaseInfo.style.display = 'block';
    } else {
      $phaseInfo.style.display = 'none';
    }
    updateButtonStates(state);
  }

  function updateButtonStates(state) {
    const phase = state.phase || 'lobby';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã
    if (phase === 'lobby') {
      // –í –ª–æ–±–±–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
    } else if (phase === 'ready') {
      // –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏
      $activateBtn.style.display = 'none';
      $activatePlayersBtn.style.display = 'inline-block';
      $deactivateBtn.style.display = 'none';
      $activatePlayersBtn.textContent = 'üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';
    } else if (phase === 'started') {
      // –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏
      $activateBtn.style.display = 'none';
      $activatePlayersBtn.style.display = 'inline-block';
      $deactivateBtn.style.display = 'none';
      $activatePlayersBtn.textContent = 'üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';
    } else if (phase === 'active') {
      // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
      $activateBtn.style.display = 'none';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'inline-block';
      $deactivateBtn.textContent = '‚èπÔ∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É';
    } else if (phase === 'finished') {
      // –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É';
    } else {
      // Fallback
      $activateBtn.style.display = 'inline-block';
      $activatePlayersBtn.style.display = 'none';
      $deactivateBtn.style.display = 'none';
      $activateBtn.textContent = 'üî¥ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
    }
  }

  function updatePlayersList(state) {
    const players = Object.values(state.players || {});
    if (players.length > 0) {
      $playersContent.innerHTML = players
        .filter(p => p.connected)
        .map(p => `
          <div class="player-item">
            <span>${p.name || p.userId}</span>
            <span>–ö–ª–∏–∫–∏: ${p.clickCount || 0}, –§–∞–ª—å—Å—Ç–∞—Ä—Ç—ã: ${p.falseStarts || 0}</span>
          </div>
        `).join('');
      $playersList.style.display = 'block';
    } else {
      $playersList.style.display = 'none';
    }
  }

  function showAnswerModal(answerData) {
    $firstAnswerer.textContent = answerData.playerName || answerData.userId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    $playerAnswer.textContent = answerData.answer || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
    $pointsInput.value = 10; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    $answerModal.style.display = 'block';
  }

  function hideAnswerModal() {
    $answerModal.style.display = 'none';
  }

  function sendAnswerConfirmation(isCorrect, points) {
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify({
      type: 'answer_confirmation',
      quizId: $room.value.trim(),
      isCorrect: isCorrect,
      points: points
    }));
    hideAnswerModal();
  }

  document.getElementById('connect').onclick = openWs;

  // –ö–Ω–æ–ø–∫–∏ ¬´–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª ‚Äî —Ç–æ–ª—å–∫–æ WS
  $activateBtn.onclick = () => {
    const duration = Math.max(0, parseInt($timer.value || '0', 10));
    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ 'ready' —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π => –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ 'started'
    sendHostSetState('ready', duration * 1000);
  };

  $activatePlayersBtn.onclick = () => {
    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É 'active' - –∏–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫—É
    sendHostSetState('active');
  };

  $deactivateBtn.onclick = () => {
    // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ - –≤–æ–∑–≤—Ä–∞—Ç –≤ 'started'
    sendHostSetState('started');
  };

  // –ì–æ—Ä—è—á–∏–µ WS-–∫–Ω–æ–ø–∫–∏
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    if (act === 'ready')       sendHostSetState('ready', Number(btn.dataset.delay) || 0);
    else if (act === 'start')  sendHostSetState('ready', 0);
    else if (act === 'active') sendHostSetState('active');
    else if (act === 'finish') sendHostSetState('finished');
    else if (act === 'reset')  sendHostSetState('lobby');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–∫–∏
  $answerCorrect.onclick = () => {
    const points = parseInt($pointsInput.value) || 0;
    sendAnswerConfirmation(true, points);
  };

  $answerWrong.onclick = () => {
    sendAnswerConfirmation(false, 0);
  };

  $answerCancel.onclick = () => {
    hideAnswerModal();
  };

  Office.onReady(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateButtonStates({ phase: 'lobby' });
  });
})();
</script>
</body>
</html>
